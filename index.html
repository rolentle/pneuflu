<html>
<head>
  <title>PneuFlu</title>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <script src="data_2015.js"></script>
  <script src="datamaps.usa.min.js"></script>
</head>
<body>
  <h1>
  <div id="container" style="position: relative; width: 1000px; height: 600px;"></div>
  <script>
    var week_1_data = data_2015.filter(function(datum) {
      return (Number(datum.mmwr_week) === 1) && 
        datum.reporting_area.indexOf(",") !== -1 &&
        !datum.all_causes_by_age_years_lt_1_flag;
    });

   var bubbleScale = d3.scale.linear()
                             .domain(d3.extent(week_1_data, function(datum) {
                                       return Number(datum.all_causes_by_age_years_all_ages);
                             }))
                             .range(["white", "red"]);


    var map = new Datamap({
      element: document.getElementById('container'),
      scope: 'usa'
    });
    var setBubbles = function(datamap, data) {
      var bubble_data = data.map(function(datum) {
        var bubble = {
          longitude: datum.location_1.longitude,
          latitude: datum.location_1.latitude,
          reporting_area: datum.reporting_area,
          radius: 10,
          all_causes_by_age_years_lt_1 : datum.all_causes_by_age_years_lt_1,
          all_causes_by_age_years_1_24 : datum.all_causes_by_age_years_1_24,
          all_causes_by_age_years_25_44 : datum.all_causes_by_age_years_25_44,
          all_causes_by_age_years_45_64 : datum.all_causes_by_age_years_45_64,
          all_causes_by_age_years_65 : datum.all_causes_by_age_years_65,
          all_causes_by_age_years_all_ages : datum.all_causes_by_age_years_all_ages,
          fill: bubbleScale(datum.all_causes_by_age_years_all_ages)
        }
        return bubble;
      });
      datamap.bubbles(bubble_data,{
        popupTemplate: function (geo, datum) {
                    return ['<div class="hoverinfo">' +  datum.reporting_area,
                    '<br/>Deaths under 1 years old: ' +  datum.all_causes_by_age_years_lt_1,
                    '<br/>Deaths between 1 and 24: ' +  datum.all_causes_by_age_years_1_24,
                    '<br/>Deaths between 25 and 44: ' +  datum.all_causes_by_age_years_25_44,
                    '<br/>Deaths between 45 and 64: ' +  datum.all_causes_by_age_years_45_64,
                    '<br/>Deaths over 65 years old: ' +  datum.all_causes_by_age_years_65,
                    '<br/>Total deaths: ' +  datum.all_causes_by_age_years_all_ages,
                    '</div>'].join('');
        }
      });
      d3.selectAll("circle.datamaps-bubble")
        .style({fill: ''})
        .attr("fill", function(datum) {
          return datum.fill;
        });
    };


    var buildSelector = function(data_set, datamap) {
      var select = d3.select("#container").append("select")
                                          .attr("id", "week_number");
      var weeks = d3.set(data_set.map(function(datum) {
        return datum.mmwr_week;
      })).values();
      var options = select.selectAll("option").data(weeks);
      options.enter()
             .append("option")
             .attr("value", function(datum) { return datum })
             .text(function(datum) { return "Week " + datum });
     select.on("change", function() {
       var week_number = Number(this.value);
       var weekly_data = data_2015.filter(function(datum) {
       return (Number(datum.mmwr_week) === week_number) && 
         datum.reporting_area.indexOf(",") !== -1 &&
         !datum.all_causes_by_age_years_lt_1_flag;
       });
       console.log(weekly_data);
       setBubbles(datamap,weekly_data);
     });
    };

    setBubbles(map, week_1_data);
    buildSelector(data_2015, map);
  </script>
</body>
</html>
